<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js" integrity="sha384-mZLF4UVrpi/QTWPA7BjNPEnkIfRFn4ZEO3Qt/HFklTJBj/gBOV8G3HcKn4NfQblz" crossorigin="anonymous"></script>
</head>
<body>
  <video style="background-color: red;"></video>
  <canvas></canvas>
  <button>送信</button>
  <script>
    const createPeerConnection = () => {
      const config = { iceServers: [] };
      const peer = new RTCPeerConnection(config);
      peer.ontrack = event => {
        // this.onAddStream(id, event.streams[0]);
      }
      peer.onremovestream = event => {
        // this.onRemoveStream(id);
      }
      peer.onicecandidate = event => {
        // this.onIceCandidate(id, event.candidate);
      }
      peer.oniceconnectionstatechange = event => {
        if (peer.iceConnectionState === 'disconnected') {
          console.log('state disconnected to: ' + id);
          // this.onDisconnect(id);
        }
      }
      return peer;
    }

    const handleRecieveOffer = (sdp) => {
      console.info('handleRecieveOffer')
    }

    const handleRecieveAnswer = (sdp) => {
      console.info('handleRecieveAnswer')
    }

    const handleRecieveSDP = (sdp) => {
      switch (sdp.type) {
        case 'offer': handleRecieveOffer(sdp); break;
        case 'answer': handleRecieveAnswer(sdp); break;
        default: console.log('unkown sdp...'); break;
      }
    }

    (async () => {
      const socket = io('http://localhost:3000')
      const button = document.querySelector('button')

      socket.on('recieve_message', (data) => {
        console.info('recieve_message', data)
      })

      button.addEventListener('click', () => {
        socket.emit('send_message', { message: 'from sender' })
      })

      // // 画面キャプチャのストリームを取得
      // const stream = await navigator.mediaDevices.getDisplayMedia({
      //   video: {
      //     displaySurface: 'monitor',
      //     frameRate: 20,
      //   },
      //   audio: false
      // })

      const makeOffer = async () => {
        const peer = createPeerConnection()

        const offer = await peer.createOffer();
        await peer.setLocalDescription(offer);

        socket.emit('SEND_SDP', offer)
      }

      socket.on('RECEIVE_SDP', handleRecieveSDP)

      makeOffer()
    })()
  </script>
</body>
</html>